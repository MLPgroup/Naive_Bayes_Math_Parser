<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article Access Dashboard</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script type="text/javascript" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* General Styling */
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* LaTeX Input Bar Styling */
        #latex-input-bar {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #latex-input {
            width: 80%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        #submit-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #submit-btn:hover {
            background-color: #0056b3;
        }

        /* Chart Container Styling */
        #chart-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            padding-bottom: 20px;
            justify-items: center;
            max-width: 1500px;
        }

        .chart-card {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            padding: 20px;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s;
            width: 100%;
            max-width: 600px;
            align-items: center;
        }

        .chart-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #343a40;
            text-align: center;
        }

        svg path {
            stroke: #333;
            stroke-width: 3px;
            transition: transform 0.2s;
        }

        /* Tooltip Styling */
        .tooltip {
            position: absolute;
            visibility: hidden;
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            width: 300px;
            z-index: 10;
            display: flex;
            flex-direction: column;
        }

        .tooltip-content {
            flex: 1;
        }

        .tooltip a {
            color: #007bff;
            text-decoration: none;
            display: block;
            margin: 5px 0;
        }

        .tooltip a:hover {
            text-decoration: underline;
        }

        .close-btn {
            align-self: flex-end;
            background: none;
            border: none;
            color: #555;
            font-size: 18px;
            cursor: pointer;
        }

        .legend {
            display: flex;
            flex-direction: column;
            white-space: nowrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            margin-right: 5px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <!-- LaTeX Input Bar -->
    <div id="latex-input-bar">
        <textarea id="latex-input" rows="3" placeholder="Enter LaTeX equation here..."></textarea>
        <button id="submit-btn">Process Equation</button>
    </div>

    <!-- Chart Container -->
    <div id="chart-container"></div>
    
    <!-- Tooltip -->
    <div id="tooltip" class="tooltip">
        <button class="close-btn" onclick="hideTooltip()">Ã—</button>
        <div class="tooltip-content"></div>
    </div>

    <script>
        // Access inverted_articles data passed from Flask
        const chartData = JSON.parse(`{{ inverted_articles | safe }}`);

        const width = 250;
        const height = 250;
        const radius = Math.min(width, height) / 2;

        const color = d3.scaleOrdinal(d3.schemeCategory10);

        const tooltip = d3.select("#tooltip");
        const tooltipContent = d3.select(".tooltip-content");
        const chartContainer = d3.select("#chart-container");

        function hideTooltip() {
            tooltip.style("visibility", "hidden");
        }

        Object.keys(chartData).forEach(function(key) {
            const data = chartData[key];

            const pieData = Object.keys(data).map(category => ({
                label: category,
                value: data[category].length,
                articles: data[category].map(article => article.replace(/\.html$/, ""))
            })).filter(d => d.value > 0);

            const totalValue = pieData.reduce((sum, d) => sum + d.value, 0);

            const chartCard = chartContainer.append("div").attr("class", "chart-card");
            chartCard.append("div").attr("class", "chart-title").text(key);

            const chartContent = chartCard.append("div").attr("class", "chart-content");
            const svg = chartContent.append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${width / 2}, ${height / 2})`);

            const pie = d3.pie().value(d => d.value);
            const arc = d3.arc().outerRadius(radius - 10).innerRadius(0);

            svg.selectAll("path")
                .data(pie(pieData))
                .enter().append("path")
                .attr("d", arc)
                .attr("fill", d => color(d.data.label))
                .on("click", function(event, d) {
                    const percentage = ((d.data.value / totalValue) * 100).toFixed(1);
                    let tooltipHtml = `<strong>${key} - ${d.data.label}</strong><br>`;
                    tooltipHtml += `<p>${percentage}% of total</p>`;
                    tooltipHtml += d.data.articles.map(article => `<a href="https://en.wikipedia.org/wiki/${encodeURIComponent(article)}" target="_blank">${article}</a>`).join('');

                    tooltipContent.html(tooltipHtml);
                    tooltip.style("visibility", "visible")
                           .style("top", (event.pageY - 20) + "px")
                           .style("left", (event.pageX + 20) + "px");
                });

            const legend = chartContent.append("div").attr("class", "legend");
            pieData.forEach((d) => {
                const legendItem = legend.append("div").attr("class", "legend-item");
                legendItem.append("div").attr("class", "legend-color").style("background-color", color(d.label));
                legendItem.append("span").text(d.label);
            });
        });

        // Submit LaTeX equation
        document.getElementById('submit-btn').addEventListener('click', () => {
            const latexInput = document.getElementById('latex-input').value;

            fetch('/process_latex', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ latex: latexInput })
            })
            .then(response => response.json())
            .then(data => {
                if (data.contentMathML) {
                    alert(`Content MathML: ${data.contentMathML}`);
                } else if (data.error) {
                    alert(`Error: ${data.error}`);
                }
            })
            .catch(error => console.error('Error:', error));
        });
    </script>
</body>
</html>
